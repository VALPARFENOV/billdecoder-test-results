# План тестирования промтов BillDecoder/LabDecoder

## Обзор проекта

BillDecoder - это система для анализа медицинских счетов и лабораторных результатов с использованием AI. Проект включает два основных компонента:
- **BillDecoder**: Анализ медицинских счетов и EOB (Explanation of Benefits)
- **LabDecoder**: Объяснение результатов лабораторных анализов

## Цели тестирования

1. **Функциональное тестирование**: Проверка корректности работы всех промтов
2. **Точность анализа**: Валидация медицинских кодов, интерпретации результатов
3. **Пользовательский опыт**: Оценка понятности и полезности ответов
4. **Безопасность**: Проверка HIPAA-совместимости и медицинских дисклеймеров
5. **Производительность**: Измерение времени ответа и надежности

## Локальная инфраструктура для тестирования

### 1. Базовая инфраструктура

#### 1.1 Docker-контейнеры
```yaml
# docker-compose.yml
version: '3.8'
services:
  hathr-api-client:
    build: ./test-infrastructure
    environment:
      - CLIENT_ID=${HATHR_CLIENT_ID}
      - CLIENT_SECRET=${HATHR_CLIENT_SECRET}
    volumes:
      - ./test-data:/app/test-data
      - ./test-results:/app/test-results
    networks:
      - test-network

  test-database:
    image: postgres:15
    environment:
      - POSTGRES_DB=test_results
      - POSTGRES_USER=test_user
      - POSTGRES_PASSWORD=test_pass
    volumes:
      - test_db_data:/var/lib/postgresql/data
    networks:
      - test-network

  test-dashboard:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./test-dashboard:/usr/share/nginx/html
    networks:
      - test-network

networks:
  test-network:
    driver: bridge

volumes:
  test_db_data:
```

#### 1.2 Структура директорий
```
test-infrastructure/
├── docker-compose.yml
├── Dockerfile
├── scripts/
│   ├── setup.sh
│   ├── run-tests.sh
│   └── cleanup.sh
├── test-data/
│   ├── bills/
│   ├── lab-results/
│   └── edge-cases/
├── test-results/
│   ├── reports/
│   ├── logs/
│   └── metrics/
└── test-dashboard/
    ├── index.html
    ├── css/
    └── js/
```

### 2. Тестовые данные

#### 2.1 Медицинские счета (BillDecoder)
- **Простые счета**: Обычный визит к врачу, анализы крови
- **Сложные счета**: Множественные провайдеры и услуги
- **Счета с ошибками**: Дублированные платежи, неправильные даты
- **Счета ER**: Высокие расходы на неотложную помощь
- **Сценарии отказа страховки**: Отклоненные заявки
- **Внешние провайдеры**: Услуги вне сети

#### 2.2 Лабораторные результаты (LabDecoder)
- **Нормальные результаты**: Все значения в пределах нормы
- **Множественные аномалии**: Несколько отклонений
- **Трендовые данные**: Результаты за 3-6 месяцев
- **Критические значения**: Требующие немедленного внимания
- **Общие панели**: Липиды, метаболические, CBC
- **Специальные тесты**: Щитовидная железа, маркеры диабета

#### 2.3 Граничные случаи
- Плохое качество изображений (размытые, повернутые, частичные)
- Рукописные заметки на документах
- Многостраничные документы
- Элементы на иностранных языках
- Необычные форматы документов

## Промты для тестирования

### 1. Основные промты BillDecoder

#### 1.1 Primary Bill Analysis Prompt
```bash
# Тест: Анализ стандартного счета
curl -X POST "$API_URL" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [
      {
        "role": "user", 
        "text": "You are a medical billing expert helping patients understand their healthcare bills. Analyze the uploaded medical bill/EOB and provide: 1. **Plain English Summary**: Translate all medical codes and terminology into simple language 2. **Financial Breakdown**: Clearly explain what patient owes vs. what insurance covered 3. **Billing Error Detection**: Flag potential overcharges, duplicate charges, or coding errors 4. **Action Items**: Specific next steps for the patient 5. **Cost Comparison**: If possible, note if charges seem unusually high for the services Format your response with clear sections and use ✅ for normal items, ⚠️ for concerns, and ❌ for definite errors."
      }
    ]
  }'
```

#### 1.2 Appeal Letter Generation Prompt
```bash
# Тест: Генерация письма апелляции
curl -X POST "$API_URL" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [
      {
        "role": "user", 
        "text": "Generate a professional insurance appeal letter based on this billing dispute: **Dispute Details**: [USER INPUT] **Patient Info**: [NAME/POLICY NUMBER - REDACTED FOR PRIVACY] **Service Details**: [FROM BILL ANALYSIS] Create a formal letter that: - References specific policy provisions - Cites medical necessity when appropriate - Includes relevant billing codes and dates - Maintains professional tone - Requests specific action and timeline Format as a ready-to-send business letter."
      }
    ]
  }'
```

#### 1.3 Bill Error Investigation Prompt
```bash
# Тест: Расследование ошибок в счетах
curl -X POST "$API_URL" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [
      {
        "role": "user", 
        "text": "Acting as a medical billing auditor, examine this bill for potential errors: Focus on: - Duplicate charges or services - Upcoding (charging for more complex service than provided) - Unbundling (separately billing components that should be bundled) - Non-covered services billed as covered - Mathematical errors in calculations - Timeline inconsistencies Provide confidence scores (1-10) for each potential error identified."
      }
    ]
  }'
```

### 2. Основные промты LabDecoder

#### 2.1 Lab Results Explanation Prompt
```bash
# Тест: Объяснение результатов лаборатории
curl -X POST "$API_URL" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [
      {
        "role": "user", 
        "text": "You are a medical educator helping patients understand their lab results. Analyze these lab values and provide: 1. **Results Summary**: Overall health picture in simple terms 2. **Individual Test Explanations**: What each test measures and why it matters 3. **Abnormal Values**: Clear explanation of any concerning results 4. **Trend Analysis**: If multiple dates available, show changes over time 5. **Next Steps**: What patient should discuss with their doctor 6. **Educational Content**: Brief background on relevant health conditions Use analogies and everyday language. Avoid medical jargon. Always remind patients to consult their healthcare provider for medical advice."
      }
    ]
  }'
```

#### 2.2 Trend Analysis Prompt
```bash
# Тест: Анализ трендов
curl -X POST "$API_URL" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [
      {
        "role": "user", 
        "text": "Analyze this series of lab results over time: **Time Period**: [DATE RANGE] **Tests Included**: [TEST NAMES] Create a health trends report showing: - Improving, stable, or declining patterns - Clinically significant changes - Correlation between different test values - Visual trend descriptions (since graphs are not available) - Risk factor progression Focus on empowering the patient with knowledge while emphasizing the need for professional medical interpretation."
      }
    ]
  }'
```

### 3. Служебные промты

#### 3.1 Confidence Scoring Prompt
```bash
# Тест: Оценка уверенности
curl -X POST "$API_URL" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [
      {
        "role": "user", 
        "text": "Rate your confidence in this analysis on a scale of 1-10 and explain any limitations: Consider factors: - Document quality/readability - Completeness of information - Complexity of medical terminology - Potential for misinterpretation - Need for human expert review Provide specific recommendations for when users should seek additional professional help."
      }
    ]
  }'
```

#### 3.2 Document Type Classification Prompt
```bash
# Тест: Классификация документов
curl -X POST "$API_URL" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [
      {
        "role": "user", 
        "text": "Classify this healthcare document and extract key metadata: Document types to identify: - Medical bill/invoice - EOB (Explanation of Benefits) - Lab results - Imaging reports - Insurance correspondence - Provider statements Extract: - Document type - Date of service - Provider name - Patient identifier (redacted) - Key services/tests mentioned - Urgency level (routine/urgent/emergency)"
      }
    ]
  }'
```

## Метрики для оценки

### 1. Метрики точности
- **Точность перевода медицинских кодов** (CPT, ICD-10, HCPCS)
- **Частота обнаружения ошибок в счетах**
- **Корректность интерпретации лабораторных значений**
- **Точность референсных диапазонов**

### 2. Метрики пользовательского опыта
- **Ясность ответов** (понятно ли обычному человеку?)
- **Полнота анализа**
- **Правильное использование форматирования** (✅⚠️❌)
- **Образовательная ценность объяснений**

### 3. Технические метрики
- **Время ответа на документ**
- **Точность оценки уверенности**
- **Обработка ошибок для плохого качества изображений**
- **HIPAA-совместимость в ответах** (отсутствие утечки персональных данных)

### 4. Метрики безопасности
- **Включение соответствующих медицинских дисклеймеров**
- **Отсутствие медицинских советов** (только образовательный контент)
- **Правильные индикаторы срочности для аномальных результатов**
- **Четкие указания консультироваться с медицинскими работниками**

## План выполнения тестирования

### Фаза 1: Подготовка инфраструктуры (1-2 дня)
1. **Настройка Docker-окружения**
   - Создание docker-compose.yml
   - Настройка контейнеров для тестирования
   - Подготовка тестовых данных

2. **Создание тестовых скриптов**
   - Адаптация существующих hathr.sh и test2.sh
   - Создание автоматизированных тестов для каждого промта
   - Настройка системы логирования

### Фаза 2: Базовое функциональное тестирование (2-3 дня)
1. **Тестирование основных промтов**
   - Primary Bill Analysis Prompt
   - Lab Results Explanation Prompt
   - Document Type Classification Prompt

2. **Тестирование с различными типами документов**
   - Простые медицинские счета
   - Нормальные лабораторные результаты
   - Стандартные EOB

### Фаза 3: Расширенное тестирование (3-4 дня)
1. **Тестирование сложных сценариев**
   - Счета с ошибками
   - Аномальные лабораторные результаты
   - Многостраничные документы

2. **Тестирование граничных случаев**
   - Плохое качество изображений
   - Необычные форматы документов
   - Документы с рукописными заметками

### Фаза 4: Тестирование производительности и безопасности (2-3 дня)
1. **Нагрузочное тестирование**
   - Одновременные запросы
   - Большие документы
   - Длительные сессии

2. **Тестирование безопасности**
   - Проверка HIPAA-совместимости
   - Валидация медицинских дисклеймеров
   - Тестирование защиты персональных данных

### Фаза 5: Анализ результатов и отчетность (1-2 дня)
1. **Сбор и анализ метрик**
2. **Создание отчетов о тестировании**
3. **Рекомендации по улучшению**

## Автоматизация тестирования

### 1. Скрипты автоматизации
```bash
#!/bin/bash
# run-all-tests.sh

# Настройка окружения
source ./scripts/setup.sh

# Запуск тестов по категориям
echo "Запуск базовых тестов..."
./scripts/test-basic-prompts.sh

echo "Запуск тестов сложных сценариев..."
./scripts/test-complex-scenarios.sh

echo "Запуск тестов граничных случаев..."
./scripts/test-edge-cases.sh

echo "Запуск тестов производительности..."
./scripts/test-performance.sh

echo "Генерация отчетов..."
./scripts/generate-reports.sh
```

### 2. Система мониторинга
- **Логирование всех запросов и ответов**
- **Метрики в реальном времени**
- **Алерты при превышении пороговых значений**
- **Дашборд для визуализации результатов**

### 3. CI/CD интеграция
```yaml
# .github/workflows/test-prompts.yml
name: Test Prompts
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-prompts:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Setup Docker
      run: docker-compose up -d
    - name: Run Tests
      run: ./scripts/run-all-tests.sh
    - name: Upload Results
      uses: actions/upload-artifact@v2
      with:
        name: test-results
        path: test-results/
```

## Критерии успеха

### 1. Функциональные критерии
- ✅ Все промты работают корректно
- ✅ Точность анализа медицинских кодов > 95%
- ✅ Обнаружение ошибок в счетах > 90%
- ✅ Корректность интерпретации лабораторных результатов > 95%

### 2. Пользовательские критерии
- ✅ Ясность ответов > 8/10
- ✅ Полнота анализа > 90%
- ✅ Правильное использование форматирования 100%
- ✅ Образовательная ценность > 8/10

### 3. Технические критерии
- ✅ Время ответа < 30 секунд
- ✅ Доступность API > 99%
- ✅ Отсутствие утечек персональных данных 100%
- ✅ Соответствие HIPAA 100%

### 4. Критерии безопасности
- ✅ Включение медицинских дисклеймеров 100%
- ✅ Отсутствие медицинских советов 100%
- ✅ Правильные индикаторы срочности 100%
- ✅ Четкие указания консультироваться с врачами 100%

## Риски и митигация

### 1. Технические риски
- **Риск**: Нестабильность API Hathr
- **Митигация**: Резервные планы, мониторинг доступности

- **Риск**: Превышение лимитов API
- **Митигация**: Контроль частоты запросов, кэширование

### 2. Качественные риски
- **Риск**: Низкая точность анализа
- **Митигация**: Итеративное улучшение промтов, экспертная валидация

- **Риск**: Несоответствие медицинским стандартам
- **Митигация**: Консультации с медицинскими экспертами

### 3. Безопасность
- **Риск**: Утечка персональных данных
- **Митигация**: Строгие протоколы анонимизации, аудит

## Заключение

Данный план тестирования обеспечивает комплексную проверку всех аспектов системы BillDecoder/LabDecoder, включая функциональность, точность, безопасность и пользовательский опыт. Локальная инфраструктура на основе Docker обеспечивает изолированную и воспроизводимую среду для тестирования, а автоматизация позволяет эффективно проводить регулярные проверки качества системы.

План предусматривает поэтапное выполнение с четкими критериями успеха и мерами по снижению рисков, что обеспечивает надежную валидацию системы перед запуском в продакшн.
